<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Mariage Dvora & Nathan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: #d4af37; color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .number { font-size: 32px; color: #d4af37; font-weight: bold; }
        .tabs { display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; background: none; border: none; font-size: 16px; }
        .tab.active { border-bottom: 3px solid #d4af37; color: #d4af37; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 8px; }
        .tab-content.active { display: block; }
        .btn { padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #c4a035; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 8px; }
        .error { color: red; margin: 10px 0; }
        .success { color: green; margin: 10px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Administration</h2>
        <div class="form-group">
            <label>Mot de passe:</label>
            <input type="password" id="adminPassword" placeholder="Entrez le mot de passe">
        </div>
        <button class="btn" style="width: 100%;" onclick="login()">Se connecter</button>
        <div id="loginError" class="error hidden"></div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="header">
            <h1>Administration - Mariage Dvora & Nathan</h1>
            <p>Gestion des invitations</p>
        </div>

        <div class="container">
            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Invités</h3>
                    <div class="number" id="totalGuests">0</div>
                </div>
                <div class="stat-card">
                    <h3>Emails Envoyés</h3>
                    <div class="number" id="emailsSent">0</div>
                </div>
                <div class="stat-card">
                    <h3>Réponses Reçues</h3>
                    <div class="number" id="responsesReceived">0</div>
                </div>
                <div class="stat-card">
                    <h3>Messages</h3>
                    <div class="number" id="messagesReceived">0</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('guests')">Invités</button>
                <button class="tab" onclick="showTab('responses')">Réponses</button>
                <button class="tab" onclick="showTab('messages')">Messages</button>
            </div>

            <!-- Tab: Invités -->
            <div id="tab-guests" class="tab-content active">
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="openAddGuestModal()">+ Ajouter un invité</button>
                    <button class="btn" onclick="sendBulkEmails()">Envoyer emails sélectionnés</button>
                </div>
                <table id="guestsTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Événements</th>
                            <th>Email envoyé</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="guestsTableBody"></tbody>
                </table>
            </div>

            <!-- Tab: Réponses -->
            <div id="tab-responses" class="tab-content">
                <table id="responsesTable">
                    <thead>
                        <tr>
                            <th>Invité</th>
                            <th>Email</th>
                            <th>Événement</th>
                            <th>Présence</th>
                            <th>+1</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="responsesTableBody"></tbody>
                </table>
            </div>

            <!-- Tab: Messages -->
            <div id="tab-messages" class="tab-content">
                <table id="messagesTable">
                    <thead>
                        <tr>
                            <th>Invité</th>
                            <th>Email</th>
                            <th>Message</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Guest -->
    <div id="guestModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Ajouter un invité</h2>
            <form id="guestForm">
                <div class="form-group">
                    <label>Prénom*</label>
                    <input type="text" id="firstName" required>
                </div>
                <div class="form-group">
                    <label>Nom*</label>
                    <input type="text" id="lastName" required>
                </div>
                <div class="form-group">
                    <label>Email*</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Téléphone</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label>Invité aux événements:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="invitedMairie"> La Mairie</label>
                        <label><input type="checkbox" id="invitedVinHonneur"> Vin d'Honneur</label>
                        <label><input type="checkbox" id="invitedChabbat"> Le Chabbat</label>
                        <label><input type="checkbox" id="invitedHouppa"> Houppa / Soirée</label>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">Enregistrer</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let password = '';
        let currentEditId = null;

        function login() {
            password = document.getElementById('adminPassword').value;

            fetch('/api/admin/guests', {
                headers: { 'password': password }
            })
            .then(res => {
                if (res.ok) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadData();
                } else {
                    document.getElementById('loginError').textContent = 'Mot de passe incorrect';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            });
        }

        function loadData() {
            loadStats();
            loadGuests();
            loadResponses();
            loadMessages();
        }

        function loadStats() {
            fetch('/api/admin/stats', {
                headers: { 'password': password }
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('totalGuests').textContent = data.totalGuests || 0;
                document.getElementById('emailsSent').textContent = data.emailsSent || 0;
                document.getElementById('responsesReceived').textContent = data.responsesReceived || 0;
                document.getElementById('messagesReceived').textContent = data.messagesReceived || 0;
            });
        }

        function loadGuests() {
            fetch('/api/admin/guests', {
                headers: { 'password': password }
            })
            .then(res => res.json())
            .then(guests => {
                const tbody = document.getElementById('guestsTableBody');
                tbody.innerHTML = guests.map(g => {
                    const events = [];
                    if (g.invited_to_mairie) events.push('Mairie');
                    if (g.invited_to_vin_honneur) events.push('Vin d\'Honneur');
                    if (g.invited_to_chabbat) events.push('Chabbat');
                    if (g.invited_to_houppa) events.push('Houppa');

                    return `
                        <tr>
                            <td><input type="checkbox" value="${g.id}" class="guest-checkbox"></td>
                            <td>${g.first_name} ${g.last_name}</td>
                            <td>${g.email}</td>
                            <td>${events.join(', ')}</td>
                            <td>${g.email_sent ? '✓ Oui' : '✗ Non'}</td>
                            <td>
                                <button class="btn" style="padding: 5px 10px; margin-right: 5px;" onclick="sendEmail(${g.id})">Envoyer</button>
                                <button class="btn" style="padding: 5px 10px; margin-right: 5px;" onclick="editGuest(${g.id})">Éditer</button>
                                <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteGuest(${g.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }

        function loadResponses() {
            fetch('/api/admin/responses', {
                headers: { 'password': password }
            })
            .then(res => res.json())
            .then(responses => {
                const tbody = document.getElementById('responsesTableBody');
                tbody.innerHTML = responses.map(r => `
                    <tr>
                        <td>${r.first_name} ${r.last_name}</td>
                        <td>${r.email}</td>
                        <td>${r.event_name}</td>
                        <td>${r.will_attend ? '✓ Oui' : '✗ Non'}</td>
                        <td>${r.plus_one || 0}</td>
                        <td>${new Date(r.created_at).toLocaleString('fr-FR')}</td>
                    </tr>
                `).join('');
            });
        }

        function loadMessages() {
            fetch('/api/admin/messages', {
                headers: { 'password': password }
            })
            .then(res => res.json())
            .then(messages => {
                const tbody = document.getElementById('messagesTableBody');
                tbody.innerHTML = messages.map(m => `
                    <tr>
                        <td>${m.first_name} ${m.last_name}</td>
                        <td>${m.email}</td>
                        <td>${m.message}</td>
                        <td>${new Date(m.created_at).toLocaleString('fr-FR')}</td>
                    </tr>
                `).join('');
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function openAddGuestModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Ajouter un invité';
            document.getElementById('guestForm').reset();
            document.getElementById('guestModal').style.display = 'block';
        }

        function editGuest(id) {
            // Implement edit functionality
            alert('Édition à implémenter');
        }

        function closeModal() {
            document.getElementById('guestModal').style.display = 'none';
        }

        document.getElementById('guestForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const data = {
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                invited_to_mairie: document.getElementById('invitedMairie').checked,
                invited_to_vin_honneur: document.getElementById('invitedVinHonneur').checked,
                invited_to_chabbat: document.getElementById('invitedChabbat').checked,
                invited_to_houppa: document.getElementById('invitedHouppa').checked
            };

            fetch('/api/admin/guests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'password': password
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(() => {
                closeModal();
                loadGuests();
                loadStats();
            });
        });

        function sendEmail(guestId) {
            if (!confirm('Envoyer l\'invitation par email?')) return;

            fetch(`/api/email/send/${guestId}`, {
                method: 'POST',
                headers: { 'password': password }
            })
            .then(res => res.json())
            .then(() => {
                alert('Email envoyé!');
                loadGuests();
                loadStats();
            })
            .catch(() => alert('Erreur lors de l\'envoi'));
        }

        function deleteGuest(id) {
            if (!confirm('Supprimer cet invité?')) return;

            fetch(`/api/admin/guests/${id}`, {
                method: 'DELETE',
                headers: { 'password': password }
            })
            .then(() => {
                loadGuests();
                loadStats();
            });
        }

        function toggleAllCheckboxes(source) {
            document.querySelectorAll('.guest-checkbox').forEach(cb => cb.checked = source.checked);
        }

        function sendBulkEmails() {
            const selected = Array.from(document.querySelectorAll('.guest-checkbox:checked')).map(cb => parseInt(cb.value));

            if (selected.length === 0) {
                alert('Sélectionnez au moins un invité');
                return;
            }

            if (!confirm(`Envoyer ${selected.length} emails?`)) return;

            fetch('/api/email/send-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'password': password
                },
                body: JSON.stringify({ guestIds: selected })
            })
            .then(res => res.json())
            .then(data => {
                alert(`Envoi terminé!\nRéussis: ${data.results.success.length}\nÉchecs: ${data.results.failed.length}`);
                loadGuests();
                loadStats();
            });
        }
    </script>
</body>
</html>
